var loginForm = document.getElementById('login')
var csrfToken = null

var fetchPostJSONOpts = {
  credentials: 'include',
  headers: {
    Accept: 'application/json',
    'Content-Type': 'application/json'
  },
  method: 'POST'
}

loginForm.addEventListener('submit', function (evt) {
  evt.preventDefault()
  window.fetch(
    '/api/login',
    Object.assign(fetchPostJSONOpts, {
      body: JSON.stringify({
        username: document.getElementById('username').value,
        password: document.getElementById('password').value
      })
    })
  )
  .then(function (r) {
    return r.json()
  })
  .then(function (r) {
    if (r.csrfToken) {
      var bscrf = new window.BrowserCSRF(r.csrfToken)
      bscrf.inject()
    }
  })
  .then(function () { return window.fetch('transfer-funds.html') })
  .then(function (r) {
    return r.text()
  })
  .then(function (html) {
    document.body.innerHTML = html
    Array.from(document.body.getElementsByTagName('script')).forEach(function (script) {
      var s = document.createElement('script')
      s.src = script.src
      document.head.appendChild(s)
    })
  })
})
