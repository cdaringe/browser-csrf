var fetchOpts = {
  method: 'GET',
  headers: {
    'Accept': 'application/json',
    'Content-Type': 'application/json',
    'Cache': 'no-cache'
  },
  credentials: 'include'
}

var form = document.getElementById('xfer')
form.addEventListener('submit', function submitXfer (evt) {
  evt.preventDefault()
  if (!state.to) return alert('please set a person to revieve funds')
  if (!state.amount) return alert('please set xfer amount')
  window.fetch('/api/transfer?' + [
    'from=' + (state.to === 'me' ? 'you' : 'me'),
    'to=' + state.to,
    'amount=' + state.amount
  ].join('&'), fetchOpts)
  .then(updateLedger)
})

var state = {
  amount: null,
  to: null
}

var $to = document.getElementById('xfer-dir')
var $amount = document.getElementById('amount')
var $me = document.getElementById('me')
var $you = document.getElementById('you')
$to.onclick = function () { state.to = state.to === 'me' ? 'you' : 'me'; render(state) }
$amount.onchange = $amount.onkeyup = function (evt) { state.amount = evt.target.value; render(state) }
function render (state) {
  if (state.to) $to.style.transform = state.to === 'me' ? 'rotate(-90deg)' : 'rotate(90deg)'
  if (state.amount) $amount.value = state.amount
  var meAmt = parseFloat(state.me, 10).toFixed(2)
  $me.innerHTML = '<small>$</small>' + (isNaN(meAmt) ? '-' : meAmt)
  var youAmt = parseFloat(state.you, 10).toFixed(2)
  $you.innerHTML = '<small>$</small>' + (isNaN(youAmt) ? '-' : youAmt)
}

function updateLedger () {
  return window.fetch('api/balance', fetchOpts)
  .then(function (body) {
    if (!body.ok) {
      throw new Error(body.statusText)
    }
    return body.json()
  })
  .then(function (ledger) {
    Object.assign(state, ledger)
    render(state)
  })
}

updateLedger()
