var express = require('express')
var app = express()
var cookieParser = require('cookie-parser')
app.use(cookieParser())

var maliciousURI = 'http://localhost:65000'

var authCookieName = 'auth'
var fakeAuthCookieValue = 'fake-p@$$0|2d'

app.get('/', function (req, res) {
  res
  .cookie(authCookieName, fakeAuthCookieValue, { httpOnly: true })
  .set('Content-Type', 'text/html')
  .send([
    'This route simulates that you\'ve just logged in.',
    `It has set an \`auth\` cookie with value: ${fakeAuthCookieValue}.`,
    `Visit <a href="${maliciousURI}">${maliciousURI}</a> to see an CSRF.`
  ].join('<br>'))
  .end()
})

app.get('/api/sensitive', function (req, res) {
  if (!req.cookies || req.cookies[authCookieName] !== fakeAuthCookieValue) {
    return res
    .set('Content-Type', 'text/html')
    .send('<h1>401 Unauthorized</h1>')
    .status(401)
    .end()
  }
  res
  .set('Content-Type', 'text/html')
  .send([
    '<h1>!! GASP !!</h1>',
    'THIS IS SENSITIVE DATA!',
    'CSRF\'d! :('
  ].join('<br>'))
  .end()
})

app.listen(7777)
